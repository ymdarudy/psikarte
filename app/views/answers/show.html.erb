<h1>回答結果</h1>
<small>
  回答日時:
  <%= times = @user.answers.scoped_by_psychology_test(@psychology_test).answered_times.sort.reverse %>
</small>
<p>※直近の回答結果を下記に表示します。</p>

<h2><%= @psychology_test.title %></h2>
<%= render "favorites/favorite_button" , p_test: @psychology_test%>
<h3>補足情報</h3>
<p><%= link_to @psychology_test.referrer, @psychology_test.referrer_url, target: :_blank, rel: "noopener noreferrer" %></p>
<% @psychology_test.supplementary_informations.each do |info|%>
  <p><%= link_to info.site_name, info.site_url, target: :_blank, rel: "noopener noreferrer" %></p>
<% end %>
<hr>

<% personality_points = [] %>

<% @psychology_test.personalities.each do |personality| %>
  <% points = @user.answers.scoped_by_personality(personality).points_with_answered_times[times[0]].collect(&:point) %>
  <% if personality.scoring_system == 1 %>
    <% point = points.sum %>
  <% elsif personality.scoring_system == 2 %>
    <% point = points.sum.fdiv(points.size) %>
  <% end %>
  <h3><%= "#{personality.name} : #{point}点" %></h3>
  <p><%= personality.description %></p>
  <% personality_points << [personality.name, point] %>
<% end %>

<%# TODO:max部分はPsychologyTestに最高点のカラムを追加して表示する必要ありかと思ったがいったん計算でいけそう %>
<%  chart_max = Question.scoped_by_test(@psychology_test).sum(:choice_max_point) / @psychology_test.personalities.count(:id) %>
<%= bar_chart personality_points, id: "bar-chart", width: "800px", height: "500px", max: chart_max, colors: ["#00b379"]  %>

<hr>
<h3>回答詳細</h3>
<hr>

<% Question.where(personality: Personality.where(psychology_test: @psychology_test)).order(:id).each_with_index do |question, i| %>
  <p><%= "#{i+1}. #{question.title}" %></p>
  <div>
    <%= question.choice_min_word %>
    <% question_point = @user.answers.where(question: question).points_with_answered_times[times[0]].first.point %>
    <% choice_points = (question.choice_min_point..question.choice_max_point).to_a %>
    <% choice_points.reverse! if question.point_reversal? %>
    <% midpoint = (question.choice_min_point + question.choice_max_point)/2.to_f %>
    <% choice_points.each do |point| %>
      <% question_point == point ? check = true : check = false %>
      <%= radio_button :answer, question.id, point, {
          style: "transform:scale(#{((midpoint - point).abs/2.to_f) + 1})",
          checked: check,
          } %>
      <%= label :answer_point, "" %>
    <% end %>
    <%= question.choice_max_word %>
  </div>
  <hr class="question-border">
<% end %>
